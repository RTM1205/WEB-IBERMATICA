import os
from SimpleHTTPServer import SimpleHTTPRequestHandler
from BaseHTTPServer import HTTPServer
from urlparse import urlparse


welcome_template = """
                        {0}
"""
report_template = """
                        {0}
"""
reportDone_template = """
			{0}
"""

class MyRequestHandler(SimpleHTTPRequestHandler):

    def do_GET(self):
        guardias_template = """
                        {0}
                        """
	report_template = """
                        {0}
                        """
        if self.path == '/':
            try:
                with open("templates/welcome.html", 'r') as w:
                        welcome_html = w.read()
                        print(welcome_html)
			welcome_template= """
                        {0}
                        """.format(welcome_html)
                        self.send_response(200)
            except:
                self.send_response(400)
                welcome_html = "File not found"
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile.write(welcome_template)
	elif self.path == '/guardias.html':
	    try:
		with open("templates/guardias.html", 'r') as g:
                        guardias_html = g.read()
                        print(guardias_html)
			guardias_template = guardias_template.format(guardias_html)
                        self.send_response(200)
	    except:
		self.send_response(400)
		guardias_html = "File not found"
	    self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile.write(guardias_template)
	elif self.path == '/report.html':
            script_list = [f for f in os.listdir('.') if f.endswith('.sh')]
	    try:
		with open("templates/report.html", 'r') as r:
                        report_html = r.read()
			report_html = report_html.format('\n'.join(['<option value="{0}">{0}</option>'.format(s) for s in script_list]))
                        print(report_html)
                        self.send_response(200)
	    except:
		self.send_response(400)
		report_html = "File not found"
            
	    self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile.write(report_template)
	elif self.path.endswith('.sh'):
	    self.send_response(200)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            script_name = self.path.split('=')[-1]
            email = self.headers.get('email', '')
            if email:
                script_name = script_name + ' ' + email
            output = subprocess.check_output(['./' + script_name + ' ' + email], cwd='.', shell=True)
	    try:
		with open("templates/reportDone.html", "r") as rd:
			reportDone_html = rd.read()
			reportDone_html = reportDone.format(script_name, output)
			self.send_response(200)
	    except:
		self.send_response(400)
		reportDone_html = "File not found"
	    reportDone_template = reportDone_template.format(reportDone_html)
	    self.wfile.write(reportDone_template)


if __name__ == '__main__':
    server = HTTPServer(('', 8000), MyRequestHandler)
    print('Server started on http://localhost:8000')
    server.serve_forever()
